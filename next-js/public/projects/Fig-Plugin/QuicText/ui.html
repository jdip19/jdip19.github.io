<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src data: blob:; connect-src https://kmkjuuytbgpozrigspgw.supabase.co https://*.supabase.co https://test.checkout.dodopayments.com https://api.dodopayments.com https://*.dodopayments.com; script-src 'unsafe-inline' 'unsafe-eval' data: blob:; style-src 'unsafe-inline' data: blob:; frame-src https://test.checkout.dodopayments.com https://*.dodopayments.com;" />
  <title>QuicText Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      padding: 20px;
      background: #ffffff;
    }

    .hidden {
      display: none !important;
    }

    /* dynamic input UI removed ‚Äî settings now provide defaults for prefix/between/suffix */

    /* License UI Styles */
    #licenseBox {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .license-header {
      text-align: center;
    }

    .license-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .license-header p {
      font-size: 14px;
      color: #666;
    }

    .usage-info {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .usage-info .remaining {
      font-size: 32px;
      font-weight: 700;
      color: #ff6b6b;
      margin: 8px 0;
    }

    .usage-info .limit-text {
      font-size: 14px;
      color: #666;
    }

    .pricing-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
    }

    .pricing-card .price {
      font-size: 48px;
      font-weight: 700;
      margin: 12px 0;
    }

    .pricing-card .price-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .features {
      list-style: none;
      margin: 20px 0;
      text-align: left;
    }

    .features li {
      padding: 8px 0;
      font-size: 14px;
    }

    .features li:before {
      content: "‚úì ";
      color: #4caf50;
      font-weight: bold;
      margin-right: 8px;
    }

    .license-input {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      font-family: monospace;
    }

    .license-input:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .activate-btn {
      padding: 12px 24px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
    }

    .activate-btn:hover {
      background: #1592e6;
    }

    .activate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .buy-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #18a0fb;
      text-decoration: none;
      font-size: 14px;
    }

    .buy-link:hover {
      text-decoration: underline;
    }

    .error-message {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
</head>

<body>
  <!-- dynamic input UI removed ‚Äî use Settings to configure defaults -->

  <!-- Settings / Dashboard header -->
  <div id="header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <div id="logo" style="font-weight:700;display:flex;align-items:center;gap:8px;">
      <img src="./quiktext-128.png" alt="" style="width:28px;height:28px;border-radius:6px;background:#eee;"> QuicText by Quickverse
    </div>
    <div id="header-actions" style="display:flex;gap:8px;align-items:center;">
      <button id="settingsBtn" title="Settings"
        style="background:transparent;border:none;cursor:pointer;font-size:16px;">‚öôÔ∏è</button>
    </div>
  </div>

  <div id="settingsBox" class="hidden">
    <h3>Defaults (applied automatically)</h3>
    <label>Prefix</label>
    <input id="defaultPrefix">
    <label>Between (used to join words)</label>
    <input id="defaultBetween">
    <label>Suffix</label>
    <input id="defaultSuffix">
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="saveDefaults" class="activate-btn">Save defaults</button>
      <button id="cancelDefaults"
        style="padding:12px 18px;border-radius:6px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;">Cancel</button>
    </div>
    <div id="defaultsSavedMsg" style="display:none;margin-top:8px;color:#18a0fb;">Defaults saved</div>
  </div>


  <!-- Pro Dashboard (visible when user has valid license) -->
  <div id="proDashboard" class="hidden">
    <h2>Pro Dashboard</h2>
    <div style="margin-top:12px;">
      <div><strong>Email:</strong> <span id="proEmail">‚Äî</span></div>
      <div><strong>Plan:</strong> <span id="proPlan">‚Äî</span></div>
      <div><strong>License key:</strong> <input id="proKey" disabled
          style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #e0e0e0;font-family:monospace;" />
      </div>
      <div style="margin-top:8px;"><strong>Activated:</strong> <span id="proActivated">‚Äî</span></div>
      <div style="margin-top:12px;"><strong>Usage:</strong> <span id="proUsage">Unlimited</span></div>

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button id="supportBtn" class="activate-btn" style="background:#6c63ff;">Support</button>
        <button id="logoutBtn"
          style="padding:12px 18px;border-radius:6px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;">Logout</button>
      </div>

    </div>
  </div>

  <div id="licenseBox" class="">
    <div class="license-header">
      <h2>üöÄ Upgrade to Pro</h2>
      <p>You've reached your daily limit</p>
    </div>

    <div class="usage-info">
      <div class="limit-text">Free commands remaining today:</div>
      <div class="remaining" id="remainingCount">0</div>
      <div class="limit-text">Limit: 10 commands/day</div>
    </div>

    <div class="pricing-card">
      <div class="price-label">Lifetime License</div>
      <div class="price">$<span id="price">9</span></div>
      <ul class="features">
        <li>Unlimited commands forever</li>
        <li>All premium features</li>
        <li>Priority support</li>
        <li>No recurring fees</li>
      </ul>
    </div>

    <div>
      <input type="text" id="licenseKeyInput" class="license-input" placeholder="Enter your license key"
        autocomplete="off">
      <div class="error-message" id="errorMessage"></div>
      <button id="activateLicense" class="activate-btn">Activate License</button>
      <a href="#" id="buyLink" class="buy-link" target="_blank">Don't have a key? Purchase here ‚Üí</a>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      dodopayments: {
        checkoutUrl: "https://test.checkout.dodopayments.com/buy/pdt_kacwOHATQ7klbZXszV8bP",
        productId: "pdt_kacwOHATQ7klbZXszV8bP",
        amount: 9,
        currency: "USD"
      }
    };

    let currentMode = null;
    let remainingCount = 0;
    let licensePrice = 9;
    let isProcessing = false;

    // Helper function to safely get element
    function getElement(id) {
      const el = document.getElementById(id);
      if (!el) {
        console.warn(`Element not found: ${id}`);
      }
      return el;
    }

    // Helper function to post message safely
    function postMessage(message) {
      try {
        if (parent && typeof parent.postMessage === 'function') {
          parent.postMessage({ pluginMessage: message }, "*");
        } else {
          console.error("Cannot post message - parent not available");
        }
      } catch (err) {
        console.error("Error posting message:", err);
      }
    }

    // Generate unique checkout session ID
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Format checkout URL with session tracking
    function getCheckoutUrl() {
      const sessionId = generateSessionId();
      const params = new URLSearchParams({
        quantity: "1",
        showDiscounts: "false",
        sessionId: sessionId,
        email: "" // User can enter email at checkout
      });
      return `${CONFIG.dodopayments.checkoutUrl}?${params.toString()}`;
    }

    // Utility: mask license key for display
    function maskKey(key) {
      if (!key) return '';
      if (key.length <= 8) return key.replace(/.(?=.{4})/g, '*');
      const first = key.slice(0, 4);
      const last = key.slice(-4);
      return `${first}****${last}`;
    }

    // Utility: format ISO date or timestamp
    function formatDate(d) {
      if (!d) return '‚Äî';
      const date = (typeof d === 'number' || !isNaN(Date.parse(d))) ? new Date(d) : null;
      if (!date) return String(d);
      return date.toLocaleString();
    }
// 
    window.onmessage = (event) => {
      try {
        const msg = event.data?.pluginMessage;
        if (!msg || typeof msg !== 'object') {
          return;
        }

        // dynamic UI removed ‚Äî plugin will always apply stored defaults

        if (msg.type === "show-license") {
          if (msg.isPro && msg.licenseData) {
            renderProView(msg.licenseData);
          } else {
            renderFreeView({
              remaining: msg.remaining,
              price: msg.price
            });

          }
        }

        if (msg.type === "license-activated") {
          const errorEl = getElement("errorMessage");
          const input = getElement("licenseKeyInput");
          if (errorEl) errorEl.classList.remove("show");
          if (input) input.value = "";
          isProcessing = false;

          // Update button state
          const btn = getElement("activateLicense");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Activate License";
          }
        }

        if (msg.type === "license-error") {
          const errorEl = getElement("errorMessage");
          if (errorEl) {
            errorEl.textContent = msg.message || "Invalid license key";
            errorEl.classList.add("show");
          }
          isProcessing = false;

          // Update button state
          const btn = getElement("activateLicense");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Activate License";
          }
        }

        if (msg.type === "usage-info") {
          console.log("Usage info received:", msg);
        }

        if (msg.type === 'current-defaults') {
          const defaults = msg.defaults || {};
          const dp = getElement('defaultPrefix');
          const db = getElement('defaultBetween');
          const ds = getElement('defaultSuffix');
          if (dp && defaults.prefix !== undefined) dp.value = defaults.prefix;
          if (db && defaults.between !== undefined) db.value = defaults.between;
          if (ds && defaults.suffix !== undefined) ds.value = defaults.suffix;
        }
      } catch (err) {
        console.error("Error in onmessage handler:", err);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      // Apply Dynamic Button
      // dynamic input removed ‚Äî no apply button

      // Activate License Button
      const licenseBtn = getElement("activateLicense");
      if (licenseBtn) {
        licenseBtn.addEventListener("click", () => {
          const input = getElement("licenseKeyInput");
          const licenseKey = input ? input.value.trim() : "";

          if (!licenseKey) {
            const errorEl = getElement("errorMessage");
            if (errorEl) {
              errorEl.textContent = "Please enter a license key";
              errorEl.classList.add("show");
            }
            return;
          }

          if (isProcessing) {
            console.warn("Already processing");
            return;
          }

          isProcessing = true;
          licenseBtn.disabled = true;
          licenseBtn.textContent = "Validating...";

          postMessage({
            type: "activate-license",
            licenseKey: licenseKey
          });
        });
      }

      // Buy License Link
      const buyLink = getElement("buyLink");
      if (buyLink) {
        buyLink.href = getCheckoutUrl();
        buyLink.addEventListener("click", (e) => {
          e.preventDefault();
          window.open(checkoutUrl, 'dodo_checkout', 'width=600,height=800');
        });

      }

      // License Key Input - Allow Enter to submit
      const keyInput = getElement("licenseKeyInput");
      if (keyInput) {
        keyInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && licenseBtn) {
            licenseBtn.click();
          }
        });

        // Clear error when user starts typing
        keyInput.addEventListener("input", () => {
          const errorEl = getElement("errorMessage");
          if (errorEl) {
            errorEl.classList.remove("show");
          }
        });
      }

      // dynamic input removed

      // Settings button
      const settingsBtn = getElement('settingsBtn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          const license = getElement('licenseBox');
          const settings = getElement('settingsBox');
          const dynamic = getElement('dynamicBox');
          if (license) license.classList.add('hidden');
          if (dynamic) dynamic.classList.add('hidden');
          if (settings) settings.classList.remove('hidden');
          // Request current defaults from plugin
          postMessage({ type: 'request-defaults' });
        });
      }

      const saveDefaultsBtn = getElement('saveDefaults');
      if (saveDefaultsBtn) {
        saveDefaultsBtn.addEventListener('click', () => {
          const dp = getElement('defaultPrefix');
          const db = getElement('defaultBetween');
          const ds = getElement('defaultSuffix');
          postMessage({ type: 'save-defaults', defaults: { prefix: dp ? dp.value : '', between: db ? db.value : '', suffix: ds ? ds.value : '' } });
        });
      }

      const cancelDefaults = getElement('cancelDefaults');
      if (cancelDefaults) {
        cancelDefaults.addEventListener('click', () => {
          const license = getElement('licenseBox');
          const settings = getElement('settingsBox');
          if (settings) settings.classList.add('hidden');
          if (license) license.classList.remove('hidden');
        });
      }

      // Pro Dashboard buttons
      const supportBtn = getElement('supportBtn');
      if (supportBtn) {
        supportBtn.addEventListener('click', () => {
          // Open support page ‚Äî replace with real support URL if available
          window.open('https://support.example.com', '_blank', 'noopener');
        });
      }

      const logoutBtn = getElement('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          renderFreeView({ remaining: 0, price: licensePrice });
          postMessage({ type: 'logout' });
        });
      }

      // Show confirmation when defaults saved
      window.addEventListener('message', (ev) => {
        try {
          const msg = ev.data?.pluginMessage;
          if (!msg) return;
          if (msg.type === 'defaults-saved') {
            const m = getElement('defaultsSavedMsg');
            if (m) {
              m.style.display = 'block';
              setTimeout(() => { m.style.display = 'none'; }, 1800);
            }
          }
        } catch (e) {
          // ignore
        }
      });
    });

    // Initial focus on load
    window.addEventListener("load", () => {
      const input = getElement("licenseKeyInput");
      if (input && !input.classList.contains("hidden")) {
        setTimeout(() => input.focus(), 100);
      }
    });
    function hideAllViews() {
      ['licenseBox', 'proDashboard'].forEach(id => {
        const el = getElement(id);
        if (el) el.classList.add('hidden');
      });
    }

    function renderFreeView(data) {
      hideAllViews();
      const licenseBox = getElement('licenseBox');
      if (licenseBox) licenseBox.classList.remove('hidden');

      if (data) {
        const remaining = getElement("remainingCount");
        const price = getElement("price");
        if (remaining) remaining.textContent = data.remaining ?? 0;
        if (price) price.textContent = data.price ?? 9;
      }

      enableSettings(false);
    }

    function renderProView(license) {
      hideAllViews();
      const proBox = getElement('proDashboard');
      if (proBox) proBox.classList.remove('hidden');

      const eEmail = getElement('proEmail');
      const ePlan = getElement('proPlan');
      const eKey = getElement('proKey');
      const eActivated = getElement('proActivated');
      const eUsage = getElement('proUsage');

      if (eEmail) eEmail.textContent = license.email || '‚Äî';
      if (ePlan) ePlan.textContent = license.plan || 'Pro';
      if (eKey) eKey.value = maskKey(license.key || '');
      if (eActivated) eActivated.textContent = formatDate(license.activatedAt);
      if (eUsage) eUsage.textContent = license.unlimited ? 'Unlimited' : '‚Äî';

      enableSettings(true);
    }

    function enableSettings(isPro) {
      const btn = getElement('settingsBtn');
      if (btn) btn.style.display = isPro ? 'block' : 'none';
    }


  </script>
</body>

</html>