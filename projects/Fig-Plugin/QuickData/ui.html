<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Inter, sans-serif;
        margin: 0;
        font-size: 14px;
        background: #196719;
        background-image: linear-gradient(120deg, #d4fc79 0%, #32cd32 100%);
      }

      .wrapper {
        padding: 20px;
      }

      input,
      button {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      button {
        background-color: #32cd32;
        color: #ffffff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 4px 0 #196719;
        position: relative;
        top: 0;
      }

      button:hover {
        background-color: #2db82d;
        box-shadow: 0 6px 0 #196719;
        top: -2px;
      }

      button:active {
        top: 4px;
        box-shadow: 0 0 0 #196719;
      }

      button:disabled {
        background-color: #ffffff;
        box-shadow: 0 4px 0 #2c2c2c;
        color: #0000007a;
        cursor: not-allowed;
        opacity: 0.7;
      }

      #fetchData {
        padding: 12px;
        border-radius: 8px;
        font-size: 15px;
      }

      .section {
        padding-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .logo {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        align-items: center;
        margin-bottom: 12px;
      }

      .logo svg {
        width: 48px;
        height: 48px;
        box-shadow: 0 4px 0 #196719;
        border-radius: 8px;
      }

      /* Table Preview Styles */
      .table-preview {
        margin-top: 12px;
        height: 145px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        align-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: block;
        border: 2px solid #32cd32;
      }
      tr.initial-message td,
      tr.loading td {
        text-align: center;
        font-size: 13px;
        font-style: italic;
        color: #a19393;
      }

      .table-preview.visible {
        display: block;
      }

      .preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      .preview-table th,
      .preview-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 60px;
      }

      .preview-table th {
        background: #f5f5f5;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
        border-bottom: 2px solid #32cd32;
      }

      .preview-table tr:hover {
        background: #f9f9f9;
      }

      .preview-table tr:last-child td {
        border-bottom: none;
      }

      /* Loading Indicator */
      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #666;
      }

      .loading td {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
      }

      .loading.visible {
        display: table-row;
      }

      /* Error Message */
      .error-message {
        display: none;
        color: #d32f2f;
        background: #fde7e7;
        padding: 12px;
        border-radius: 8px;
        margin: 12px 0;
        font-size: 13px;
        border: 1px solid #ffa4a4;
      }

      .error-message.visible {
        display: block;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 16px;
        border-radius: 12px;
        max-width: 400px;
        width: 80%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        position: relative;
        height: 80%;
        overflow-y: scroll;
      }

      .modal-title {
        margin-top: 0;
        color: #232323;
        font-weight: 600;
      }

      .modal-list {
        padding-left: 18px;
        color: #232323;
      }

      .modal-list li {
        margin-bottom: 8px;
      }

      input[type="text"] {
        width: calc(100% - 40px);
        padding: 12px;
        border-radius: 8px 0 0 8px;
        border: 2px solid #32cd32;
        background: rgb(255 255 255);
        color: #0a0a0a;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 0 #196719;
        margin: 0;
      }

      input[type="text"]:focus {
        border-color: #196719;
        outline: none;
        box-shadow: 0 4px 0 #196719;
        transform: translateY(-2px);
      }

      input[type="text"]:hover {
        border-color: #196719;
        box-shadow: 0 3px 0 #196719;
        transform: translateY(-1px);
      }

      ::placeholder {
        color: #000000;
        opacity: 0.6;
        font-weight: 400;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        position: absolute;
        align-items: baseline;
        bottom: 0;
        background: #2c2c2c;
        padding: 12px;
        text-align: center;
        width: -webkit-fill-available;
        font-size: 12px;
        color: #fff;
        border-top: 1px solid transparent;
      }

      .footer a {
        color: #32cd32;
        text-decoration: none;
      }

      .info-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        margin: 0;
        box-shadow: none;
        width: auto;
      }

      .info-btn:hover,
      .info-btn:active {
        box-shadow: none;
        top: 0;
      }

      .input-group {
        display: flex;
        align-items: stretch;
      }

      .refresh-button {
        width: 40px;
        padding: 12px 8px;
        border: 2px solid #32cd32;
        border-left: none;
        background: #32cd32;
        color: white;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 0 #196719;
      }

      .refresh-button:hover {
        background-color: #2db82d;
      }

      .refresh-button:active {
        transform: translateY(2px);
        box-shadow: none;
      }

      .refresh-button svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      .refresh-button.spinning svg, .loading td{
        animation: spin 1s linear infinite;
        border: 0;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Button container */
      .button-container {
        margin-top: 12px;
      }

      .button-container.visible {
        display: block;
      }

      #fetchData {
        width: 100%;
      }

      /* Message Styles */
      tr.message td {
        text-align: center;
        font-size: 13px;
        font-style: italic;
        color: #a19393;
        padding: 20px;
      }

      tr.message.error td {
        color: #d32f2f;
        background: #fde7e7;
      }

      tr.message.loading td {
        animation: spin 1s linear infinite;
        border: 0;
      }

      .refresh-button.spinning svg {
        animation: spin 1s linear infinite;
        border: 0;
      }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
  </head>

  <body>
    <div class="wrapper">
      <div class="logo">
        <svg
          width="48"
          height="48"
          viewBox="0 0 1080 1080"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g clip-path="url(#clip0_175_2)">
            <rect width="1080" height="1080" fill="url(#paint0_linear_175_2)" />
            <path
              d="M1212.13 692.4C1212.13 759.209 1201.96 825.534 1181.63 891.374C1162.26 957.214 1133.22 1019.67 1094.49 1078.73C1055.76 1137.79 1007.83 1190.08 950.703 1235.58C893.577 1281.09 827.736 1316.92 753.182 1343.06C679.595 1369.2 596.811 1382.27 504.828 1382.27C490.304 1382.27 471.424 1381.79 448.186 1380.82C424.948 1379.85 399.774 1379.37 372.663 1379.37C346.52 1378.4 319.41 1377.92 291.331 1377.92C269.061 1377.92 244.855 1378.4 218.713 1379.37C192.57 1379.37 167.88 1379.85 144.642 1380.82C122.373 1380.82 103.492 1381.3 88 1382.27L92.3571 1353.23C123.341 1351.29 147.547 1347.42 164.975 1341.61C183.372 1335.8 197.895 1324.18 208.546 1306.75C219.197 1289.32 228.879 1263.18 237.593 1228.32L427.853 507.95C435.599 478.903 438.987 455.665 438.019 438.237C438.019 419.84 430.757 406.285 416.234 397.571C402.678 388.857 378.472 384.015 343.616 383.047L347.973 354C364.433 354.968 384.766 355.936 408.972 356.905C433.178 357.873 458.836 358.357 485.947 358.357C514.026 358.357 540.653 358.357 565.827 358.357C584.224 357.389 606.977 356.905 634.088 356.905C661.199 355.936 688.31 355.452 715.42 355.452C742.531 354.484 765.285 354 783.681 354C923.108 354 1029.13 382.563 1101.75 439.689C1175.34 496.816 1212.13 581.053 1212.13 692.4ZM499.018 1356.13C565.827 1356.13 625.858 1343.06 679.111 1316.92C733.333 1290.77 780.777 1254.46 821.443 1207.99C863.077 1161.51 897.45 1108.26 924.56 1048.23C952.64 988.198 973.457 924.294 987.012 856.517C1001.54 787.772 1008.8 719.027 1008.8 650.282C1008.8 561.204 988.464 493.911 947.798 448.404C907.132 402.896 840.808 380.142 748.825 380.142C722.682 380.142 702.349 383.531 687.826 390.309C673.302 396.118 661.683 408.221 652.969 426.618C644.255 444.046 635.54 470.189 626.826 505.046L436.567 1231.23C427.853 1261.24 422.527 1285.45 420.591 1303.84C419.623 1322.24 424.948 1335.8 436.567 1344.51C448.186 1352.26 469.003 1356.13 499.018 1356.13Z"
              fill="white"
            />
            <path
              d="M-109 1432.5L163.216 166.452L794 166.452"
              stroke="url(#paint1_linear_175_2)"
              stroke-opacity="0.1"
              stroke-width="49.0479"
            />
            <path
              d="M977.441 164L793.512 270.192V57.8083L977.441 164ZM807 164V145.607H811.905V164V182.393H807V164Z"
              fill="#090909"
              fill-opacity="0.1"
            />
          </g>
          <defs>
            <linearGradient
              id="paint0_linear_175_2"
              x1="-182.5"
              y1="-124"
              x2="540"
              y2="1080"
              gradientUnits="userSpaceOnUse"
            >
              <stop stop-color="#D4FC79" />
              <stop offset="1" stop-color="#32CD32" />
            </linearGradient>
            <linearGradient
              id="paint1_linear_175_2"
              x1="393.434"
              y1="166.452"
              x2="393.434"
              y2="1432.5"
              gradientUnits="userSpaceOnUse"
            >
              <stop stop-color="#090909" />
              <stop offset="1" stop-color="#090909" stop-opacity="0" />
            </linearGradient>
            <clipPath id="clip0_175_2">
              <rect width="1080" height="1080" fill="white" />
            </clipPath>
          </defs>
        </svg>
      </div>
      <div class="section">
        <div class="input-group">
        <input
          type="text"
          id="sheetUrl"
            placeholder="Paste your Google Sheet URL here to fetch data automatically"
          />
          <button class="refresh-button" id="refreshBtn" title="Refresh data">
            <svg viewBox="0 0 24 24">
              <path
                d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
              />
            </svg>
          </button>
        </div>
        <div class="table-preview" id="tablePreview">
          <table class="preview-table" id="previewTable">
            <tbody>
              <tr class="message" id="messageRow">
                <td>Data will be previewed here</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="button-container" id="buttonContainer">
          <button id="fetchData">Sync with Selected Layers</button>
        </div>
      </div>
    </div>

    <div id="infoModal" class="modal">
      <div class="modal-content">
        <h3 class="modal-title">How to use QuickData</h3>
        <ol class="modal-list">
          <li>
            Make your Google Sheet public (File → Share → Anyone with the link)
          </li>
          <li>Copy and paste your Google Sheet URL</li>
          <li>
            Name your Figma layers with # followed by the column name:
            <ul style="margin-top: 8px">
              <li>Example: If column is "Name", layer should be "#Name"</li>
              <li>Column "Product" → Layer "#Product"</li>
              <li>Spaces and special characters are removed automatically</li>
            </ul>
          </li>
          <li>Select the layers you want to update</li>
          <li>
            Click "Sync" and watch the magic happen:
            <ul style="margin-top: 8px">
              <li>Text layers: Both name and content update</li>
              <li>Other layers: Names update only</li>
              <li>Multiple layers can use the same column</li>
            </ul>
          </li>
        </ol>
      </div>
    </div>

    <footer class="footer">
      <div>
        Liked the plugin?&nbsp;<a
          href="https://jdip19.github.io/support-jdip.html"
          target="_blank"
        >
          Buy me tea 🍵</a
        >
      </div>
      <div>
        <button id="infoBtn" class="info-btn" title="How to use">ℹ️</button>
      </div>
    </footer>

    <script>
      let currentCallback = null;
      let debounceTimer;
      let currentSheetData = null;

      // Debounce function
      function debounce(func, wait) {
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(debounceTimer);
            func(...args);
          };
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(later, wait);
        };
      }

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "selection-info") {
          selectedLayers = msg.names || [];
          selectionTypes = msg.types || [];
          validateUI();
        } else if (msg.type === "load-url") {
          document.getElementById("sheetUrl").value = msg.url;
          validateUI();
        }
      };

      function extractSheetInfo(url) {
        const idMatch = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        const gidMatch = url.match(/gid=([0-9]+)/);
        return {
          id: idMatch ? idMatch[1] : null,
          gid: gidMatch ? gidMatch[1] : "0",
        };
      }

      window.google = {
        visualization: {
          Query: {
            setResponse: function (response) {
              if (currentCallback) {
                currentCallback(response);
              }
            },
          },
        },
      };

      // Filter out empty columns
      function filterEmptyColumns(data) {
        if (!data || data.length < 2) return data;

        const headers = data[0];
        const nonEmptyColumnIndexes = [];

        // Check each column
        for (let colIndex = 0; colIndex < headers.length; colIndex++) {
          let hasValue = false;
          // Check values in each row for this column
          for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
            const value = data[rowIndex][colIndex];
            if (value !== null && value !== undefined && value !== "") {
              hasValue = true;
              break;
            }
          }
          if (hasValue) {
            nonEmptyColumnIndexes.push(colIndex);
          }
        }

        // Filter the data to keep only non-empty columns
        return data.map((row) =>
          nonEmptyColumnIndexes.map((colIndex) => row[colIndex])
        );
      }

      // Display data in table
      function displayTablePreview(data) {
        const tablePreview = document.getElementById("tablePreview");
        const previewTable = document.getElementById("previewTable");
        const buttonContainer = document.getElementById("buttonContainer");
        const messageRow = document.getElementById("messageRow");

        if (!data || data.length < 2) {
          messageRow.className = "message";
          messageRow.querySelector("td").textContent = "Data will be previewed here";
          buttonContainer.classList.remove("visible");
          return;
        }

        // Clear existing table content
        previewTable.innerHTML = "";

        // Create header row
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        data[1].forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        previewTable.appendChild(thead);

        // Create body rows
        const tbody = document.createElement("tbody");
        for (let i = 2; i < Math.min(data.length, 5); i++) {
          const row = document.createElement("tr");
          data[i].forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell;
            row.appendChild(td);
          });
          tbody.appendChild(row);
        }
        previewTable.appendChild(tbody);

        tablePreview.classList.add("visible");
        buttonContainer.classList.add("visible");
      }

      async function fetchSheetData(sheetId, gid) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          const callbackName = "google.visualization.Query.setResponse";

          currentCallback = (response) => {
            document.body.removeChild(script);
            if (response.status === "error") {
              reject(new Error(response.errors[0].message));
              return;
            }

            const table = response.table;
            const headers = table.cols.map((col) => col.label);
            const rows = table.rows.map((row) =>
              row.c.map((cell) =>
                cell && cell.v !== null && cell.v !== undefined ? cell.v : ""
              )
            );

            resolve([headers, ...rows]);
          };

          script.src = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
          script.onerror = () => reject(new Error("Failed to load sheet data"));
          document.body.appendChild(script);
        });
      }

      // Handle URL input with debounce
      const handleUrlInput = debounce(async (event) => {
        await fetchAndDisplayData();
      }, 1500);

      async function fetchAndDisplayData() {
        const sheetUrl = document.getElementById("sheetUrl").value.trim();
        const { id: sheetId, gid } = extractSheetInfo(sheetUrl);
        const messageRow = document.getElementById("messageRow");
        const refreshBtn = document.getElementById("refreshBtn");
        const buttonContainer = document.getElementById("buttonContainer");

        // Reset UI
        messageRow.className = "message";
        buttonContainer.classList.remove("visible");

        if (!sheetId) {
          messageRow.className = "message error";
          messageRow.querySelector("td").textContent = "Please enter a valid Google Sheet URL";
          return;
        }

        try {
          messageRow.className = "message loading";
          messageRow.querySelector("td").textContent = "⏳";
          refreshBtn.classList.add("spinning");
          
          const data = await fetchSheetData(sheetId, gid);
          currentSheetData = filterEmptyColumns(data);
          displayTablePreview(currentSheetData);
          validateUI();
        } catch (error) {
          messageRow.className = "message error";
          messageRow.querySelector("td").textContent = "Error loading sheet data: " + error.message;
          buttonContainer.classList.remove("visible");
        } finally {
          refreshBtn.classList.remove("spinning");
        }
      }

      document
        .getElementById("sheetUrl")
        .addEventListener("input", handleUrlInput);

      document
        .getElementById("refreshBtn")
        .addEventListener("click", async () => {
          await fetchAndDisplayData();
        });

      document.getElementById("fetchData").onclick = async () => {
        if (!currentSheetData) {
          const sheetUrl = document.getElementById("sheetUrl").value.trim();
          const { id: sheetId, gid } = extractSheetInfo(sheetUrl);

          if (!sheetId) {
            document.getElementById("errorMessage").textContent =
              "Please enter a valid Google Sheet URL";
            document.getElementById("errorMessage").classList.add("visible");
            return;
          }

          try {
            document.getElementById("loading").classList.add("visible");
            const data = await fetchSheetData(sheetId, gid);
            currentSheetData = filterEmptyColumns(data);
          } catch (error) {
            document.getElementById("errorMessage").textContent =
              "Error loading sheet data: " + error.message;
            document.getElementById("errorMessage").classList.add("visible");
            document.getElementById("loading").classList.remove("visible");
            return;
          }
          }

          parent.postMessage(
            {
              pluginMessage: {
                type: "update-layers",
              data: currentSheetData,
              sheetUrl: document.getElementById("sheetUrl").value.trim(),
              },
            },
            "*"
          );
      };

      function validateUI() {
        const fetchButton = document.getElementById("fetchData");
        const sheetUrl = document.getElementById("sheetUrl").value.trim();
        const hasValidUrl = sheetUrl && extractSheetInfo(sheetUrl).id;
        const hasData = currentSheetData && currentSheetData.length > 1;
        const layerCount = selectedLayers ? selectedLayers.length : 0;

        fetchButton.disabled = !hasValidUrl || layerCount === 0;

        if (!hasValidUrl) {
          fetchButton.textContent = "Enter valid sheet URL";
          } else if (layerCount === 0) {
            fetchButton.textContent = "Select layers to sync";
        } else {
          fetchButton.textContent = `Sync (${layerCount} layer${
            layerCount > 1 ? "s" : ""
          })`;
        }
      }

      let selectedLayers = [];
      let selectionTypes = [];

      document.getElementById("infoBtn").addEventListener("click", () => {
        document.getElementById("infoModal").style.display = "flex";
      });

      document.getElementById("infoModal").addEventListener("click", (e) => {
        if (e.target.id === "infoModal") {
          document.getElementById("infoModal").style.display = "none";
        }
      });

      validateUI();
    </script>
  </body>
</html>
