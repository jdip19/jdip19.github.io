<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src data: blob:; connect-src https://kmkjuuytbgpozrigspgw.supabase.co https://*.supabase.co https://test.checkout.dodopayments.com https://api.dodopayments.com https://*.dodopayments.com; script-src 'unsafe-inline' 'unsafe-eval' data: blob:; style-src 'unsafe-inline' data: blob:; frame-src https://test.checkout.dodopayments.com https://*.dodopayments.com;" />
  <title>QuicText Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      padding: 20px;
      background: #ffffff;
    }

    .hidden {
      display: none !important;
    }

    /* dynamic input UI removed — settings now provide defaults for prefix/between/suffix */

    /* License UI Styles */
    #licenseBox {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .license-header {
      text-align: center;
    }

    .license-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .license-header p {
      font-size: 14px;
      color: #666;
    }

    .usage-info {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .usage-info .remaining {
      font-size: 32px;
      font-weight: 700;
      color: #ff6b6b;
      margin: 8px 0;
    }

    .usage-info .limit-text {
      font-size: 14px;
      color: #666;
    }

    .pricing-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
    }

    .pricing-card .price {
      font-size: 48px;
      font-weight: 700;
      margin: 12px 0;
    }

    .pricing-card .price-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .features {
      list-style: none;
      margin: 20px 0;
      text-align: left;
    }

    .features li {
      padding: 8px 0;
      font-size: 14px;
    }

    .features li:before {
      content: "✓ ";
      color: #4caf50;
      font-weight: bold;
      margin-right: 8px;
    }

    .license-input {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      font-family: monospace;
    }

    .license-input:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .activate-btn {
      padding: 12px 24px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
    }

    .activate-btn:hover {
      background: #1592e6;
    }

    .activate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .buy-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #18a0fb;
      text-decoration: none;
      font-size: 14px;
    }

    .buy-link:hover {
      text-decoration: underline;
    }

    .error-message {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
</head>

<body>
  <!-- dynamic input UI removed — use Settings to configure defaults -->

  <!-- Settings / Dashboard header -->
  <div id="header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <div id="logo" style="font-weight:700;display:flex;align-items:center;gap:8px;">
      <svg width="24" height="24" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_96_2)">
          <path
            d="M0 10.449C0 4.67817 4.67817 0 10.449 0H117.551C123.322 0 128 4.67817 128 10.449V117.551C128 123.322 123.322 128 117.551 128H10.449C4.67817 128 0 123.322 0 117.551V10.449Z"
            fill="url(#paint0_linear_96_2)" />
          <path
            d="M33.004 27.2482V30.5119H47.2237V27.2482H61.4444V30.5119H75.6651V27.2482H89.8858V30.5119H104.106V27.2482H118.326V30.5119H132.547V27.2482H143.289L142.902 30.8596L142.039 38.9055L138.794 38.5578L137.068 54.6486L140.314 54.9963L138.588 71.0871L135.342 70.7385L133.616 86.8303L136.861 87.1779L135.136 103.27L131.891 102.921L130.165 119.012L133.41 119.361L131.685 135.451L128.44 135.103L128.439 135.102L126.713 151.194L129.959 151.542L129.096 159.588L128.783 162.503H118.74V159.239H104.52V162.503H90.2999V159.239H76.0792V162.503H61.8585V159.239H47.6378V162.503H33.4181V159.239H19.1974V162.503H8.45419L8.84189 158.892L9.70517 150.846L12.9493 151.194L14.6749 135.102L11.4308 134.755L13.1563 118.664L16.4015 119.012L18.127 102.921L14.8819 102.573L16.6075 86.4826L19.8526 86.8303L21.5782 70.7385L18.3341 70.3908L20.0597 54.3L23.3048 54.6486L25.0304 38.5578L21.7852 38.2092L22.6485 30.1642L22.961 27.2482H33.004Z"
            stroke="black" stroke-opacity="0.1" stroke-width="6.52733" stroke-dasharray="15.67 15.67" />
          <path d="M14.9969 18.8049H40.5931L37.4868 40.1765H11.8906L14.9969 18.8049Z" fill="black" fill-opacity="0.1" />
          <path d="M128.478 18.1203H154.074L150.968 39.4919H125.371L128.478 18.1203Z" fill="black" fill-opacity="0.1" />
          <path
            d="M135.703 45.3929C133.633 52.4767 131.563 66.694 129.992 77.0702L123.232 77.4194C123.232 74.3016 122.883 68.4151 122.035 65.1227C120.813 59.0616 117.869 56.6421 106.795 56.6421H96.7678L81.004 139.552C78.5846 152.198 79.4576 154.443 95.5456 155.465L94.1489 161.526H38.2522L39.624 155.465C54.3402 154.418 55.737 151.824 58.1565 139.552L74.2445 56.6421H66.9862C54.1656 56.6421 51.0478 58.5378 47.4311 63.4016C46.7826 64.2247 46.159 65.0728 45.5355 65.9707C43.565 68.8641 41.7192 72.3062 39.4744 77.0702L32.7149 76.8956C34.7851 69.6872 36.7307 62.7282 38.2771 56.243C39.1751 52.4517 39.9483 48.835 40.522 45.3929H45.1863C47.0819 49.0346 48.6284 49.0346 53.2927 49.0346H122.01C126.325 49.0346 126.849 48.5108 130.49 45.3929H135.703Z"
            fill="white" stroke="white" stroke-width="0.241591" />
          <path
            d="M83.3663 23.6312C83.3663 16.9108 88.8143 11.4629 95.5347 11.4629H129.04V35.7995H95.5347C88.8143 35.7995 83.3663 30.3516 83.3663 23.6312Z"
            fill="url(#paint1_linear_96_2)" />
          <path
            d="M91.9437 28.6312L93.5806 18.7715H97.4705C98.2152 18.7715 98.8266 18.9143 99.3048 19.1999C99.7862 19.4824 100.123 19.8756 100.316 20.3795C100.512 20.8801 100.557 21.4579 100.451 22.1126C100.341 22.7706 100.104 23.3499 99.7381 23.8506C99.3754 24.3481 98.9036 24.7364 98.3227 25.0156C97.7417 25.2949 97.071 25.4345 96.3103 25.4345H93.8309L94.1053 23.7639H96.2477C96.6521 23.7639 96.9971 23.6949 97.2828 23.5569C97.5716 23.4157 97.8011 23.2215 97.9712 22.9744C98.1413 22.724 98.2521 22.4368 98.3034 22.1126C98.358 21.782 98.3403 21.4948 98.2505 21.2508C98.1606 21.0069 97.9953 20.8176 97.7546 20.6828C97.5171 20.5447 97.1977 20.4757 96.7965 20.4757H95.3908L94.0283 28.6312H91.9437ZM100.721 28.6312L102.358 18.7715H106.248C106.993 18.7715 107.606 18.9031 108.087 19.1662C108.572 19.4294 108.912 19.8033 109.108 20.288C109.307 20.7694 109.353 21.3375 109.248 21.9922C109.138 22.647 108.903 23.2087 108.54 23.6773C108.18 24.1459 107.712 24.5069 107.134 24.7605C106.56 25.0108 105.894 25.136 105.136 25.136H102.532L102.82 23.4606H105.083C105.481 23.4606 105.821 23.4061 106.104 23.2969C106.386 23.1878 106.609 23.0241 106.773 22.8059C106.94 22.5876 107.049 22.3164 107.1 21.9922C107.155 21.6617 107.136 21.3856 107.043 21.1642C106.95 20.9395 106.781 20.7694 106.537 20.6539C106.293 20.5351 105.972 20.4757 105.574 20.4757H104.168L102.806 28.6312H100.721ZM106.787 24.1443L108.497 28.6312H106.195L104.539 24.1443H106.787ZM119.557 23.8361C119.378 24.8889 119.029 25.7827 118.513 26.5177C117.999 27.2527 117.372 27.8112 116.63 28.1931C115.892 28.575 115.096 28.766 114.242 28.766C113.347 28.766 112.575 28.5622 111.927 28.1546C111.282 27.747 110.815 27.158 110.526 26.3877C110.237 25.6142 110.182 24.6818 110.362 23.5906C110.535 22.5347 110.88 21.6392 111.397 20.9042C111.914 20.166 112.545 19.6043 113.289 19.2192C114.034 18.8308 114.835 18.6367 115.692 18.6367C116.581 18.6367 117.348 18.8421 117.993 19.2529C118.641 19.6637 119.108 20.2575 119.394 21.0342C119.683 21.8077 119.737 22.7417 119.557 23.8361ZM117.482 23.5906C117.595 22.9134 117.59 22.3453 117.468 21.8863C117.349 21.4242 117.131 21.0743 116.813 20.8368C116.496 20.5993 116.094 20.4806 115.61 20.4806C115.083 20.4806 114.6 20.6121 114.161 20.8753C113.724 21.1385 113.355 21.5204 113.053 22.0211C112.755 22.5186 112.548 23.1236 112.432 23.8361C112.317 24.5166 112.32 25.0846 112.442 25.5404C112.567 25.9962 112.79 26.3412 113.111 26.5755C113.435 26.8066 113.838 26.9221 114.319 26.9221C114.843 26.9221 115.321 26.7937 115.754 26.537C116.191 26.277 116.558 25.8999 116.857 25.4056C117.155 24.9081 117.364 24.3031 117.482 23.5906Z"
            fill="#FE5D34" />
        </g>
        <defs>
          <linearGradient id="paint0_linear_96_2" x1="-78.5778" y1="26.7852" x2="44.1925" y2="215.083"
            gradientUnits="userSpaceOnUse">
            <stop stop-color="#FD371F" />
            <stop offset="1" stop-color="#FF844B" />
          </linearGradient>
          <linearGradient id="paint1_linear_96_2" x1="83.3663" y1="23.6312" x2="140.93" y2="18.0339"
            gradientUnits="userSpaceOnUse">
            <stop stop-color="white" />
            <stop offset="1" stop-color="white" stop-opacity="0" />
          </linearGradient>
          <clipPath id="clip0_96_2">
            <path
              d="M0 10.449C0 4.67817 4.67817 0 10.449 0H117.551C123.322 0 128 4.67817 128 10.449V117.551C128 123.322 123.322 128 117.551 128H10.449C4.67817 128 0 123.322 0 117.551V10.449Z"
              fill="white" />
          </clipPath>
        </defs>
      </svg>
      QuicText
      by Quiclab
    </div>
    <div id="header-actions" style="display:flex;gap:8px;align-items:center;">
      <button id="settingsBtn" title="Settings"
        style="background:transparent;border:none;cursor:pointer;font-size:16px;">⚙️</button>
    </div>
  </div>

  <div id="settingsBox" class="hidden">
    <h3>Defaults (applied automatically)</h3>
    <label>Prefix</label>
    <input id="defaultPrefix">
    <label>Between (used to join words)</label>
    <input id="defaultBetween">
    <label>Suffix</label>
    <input id="defaultSuffix">
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="saveDefaults" class="activate-btn">Save defaults</button>
      <button id="cancelDefaults"
        style="padding:12px 18px;border-radius:6px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;">Cancel</button>
    </div>
    <div id="defaultsSavedMsg" style="display:none;margin-top:8px;color:#18a0fb;">Defaults saved</div>
  </div>


  <!-- Pro Dashboard (visible when user has valid license) -->
  <div id="proDashboard" class="hidden">
    <h2>Pro Dashboard</h2>
    <div style="margin-top:12px;">
      <div><strong>Email:</strong> <span id="proEmail">—</span></div>
      <div><strong>Plan:</strong> <span id="proPlan">—</span></div>
      <div><strong>License key:</strong> <input id="proKey" disabled
          style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #e0e0e0;font-family:monospace;" />
      </div>
      <div style="margin-top:8px;"><strong>Activated:</strong> <span id="proActivated">—</span></div>
      <div style="margin-top:12px;"><strong>Usage:</strong> <span id="proUsage">Unlimited</span></div>

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button id="supportBtn" class="activate-btn" style="background:#6c63ff;">Support</button>
        <button id="logoutBtn"
          style="padding:12px 18px;border-radius:6px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;">Logout</button>
      </div>

    </div>
  </div>

  <div id="licenseBox" class="">
    <div class="license-header">
      <h2>Upgrade to Pro</h2>
      <p>You've reached your daily limit</p>
    </div>

    <div class="usage-info">
      <div class="limit-text">Free commands remaining today:</div>
      <div class="remaining" id="remainingCount">0</div>
      <div class="limit-text">Limit: 10 commands/day</div>
    </div>

    <div class="pricing-card">
      <div class="price-label">Lifetime License</div>
      <div class="price">$<span id="price"></span></div>
      <ul class="features">
        <li>Unlimited commands forever</li>
        <li>All premium features</li>
        <li>Priority support</li>
        <li>No recurring fees</li>
      </ul>
    </div>

    <div>
      <input type="text" id="licenseKeyInput" class="license-input" placeholder="Enter your license key"
        autocomplete="off">
      <div class="error-message" id="errorMessage"></div>
      <button id="activateLicense" class="activate-btn">Activate License</button>
      <a href="#" id="buyLink" class="buy-link" target="_blank">Don't have a key? Purchase here →</a>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      dodopayments: {
        checkoutUrl: "https://checkout.dodopayments.com/buy/pdt_SEP94Xh88Gqpram39DT5X"
      }
    };


    let currentMode = null;
    let remainingCount = 0;
    let licensePrice = 9;
    let isProcessing = false;

    // Helper function to safely get element
    function getElement(id) {
      const el = document.getElementById(id);
      if (!el) {
        console.warn(`Element not found: ${id}`);
      }
      return el;
    }

    // Helper function to post message safely
    function postMessage(message) {
      try {
        if (parent && typeof parent.postMessage === 'function') {
          parent.postMessage({ pluginMessage: message }, "*");
        } else {
          console.error("Cannot post message - parent not available");
        }
      } catch (err) {
        console.error("Error posting message:", err);
      }
    }


    // Format checkout URL with session tracking
    function getCheckoutUrl() {
      const params = new URLSearchParams({
        quantity: "1",
        redirect_url: "https://jdip.vercel.app/payment",
        showDiscounts: "false"
      });

      return `${CONFIG.dodopayments.checkoutUrl}?${params.toString()}`;
    }


    // Utility: mask license key for display
    function maskKey(key) {
      if (!key) return '';
      if (key.length <= 8) return key.replace(/.(?=.{4})/g, '*');
      const first = key.slice(0, 4);
      const last = key.slice(-4);
      return `${first}****${last}`;
    }

    // Utility: format ISO date or timestamp
    function formatDate(d) {
      if (!d) return '—';
      const date = (typeof d === 'number' || !isNaN(Date.parse(d))) ? new Date(d) : null;
      if (!date) return String(d);
      return date.toLocaleString();
    }
    // 
    window.onmessage = (event) => {
      try {
        const msg = event.data?.pluginMessage;
        if (!msg || typeof msg !== 'object') {
          return;
        }

        // dynamic UI removed — plugin will always apply stored defaults

        if (msg.type === "show-license") {
          if (msg.isPro && msg.licenseData) {
            renderProView(msg.licenseData);
          } else {
            renderFreeView({
              remaining: msg.remaining,
              price: msg.price
            });

          }
        }

        if (msg.type === "license-activated") {
          const errorEl = getElement("errorMessage");
          const input = getElement("licenseKeyInput");
          if (errorEl) errorEl.classList.remove("show");
          if (input) input.value = "";
          isProcessing = false;

          // Update button state
          const btn = getElement("activateLicense");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Activate License";
          }
        }

        if (msg.type === "license-error") {
          const errorEl = getElement("errorMessage");
          if (errorEl) {
            errorEl.textContent = msg.message || "Invalid license key";
            errorEl.classList.add("show");
          }
          isProcessing = false;

          // Update button state
          const btn = getElement("activateLicense");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Activate License";
          }
        }

        if (msg.type === "usage-info") {
          console.log("Usage info received:", msg);
        }

        if (msg.type === 'current-defaults') {
          const defaults = msg.defaults || {};
          const dp = getElement('defaultPrefix');
          const db = getElement('defaultBetween');
          const ds = getElement('defaultSuffix');
          if (dp && defaults.prefix !== undefined) dp.value = defaults.prefix;
          if (db && defaults.between !== undefined) db.value = defaults.between;
          if (ds && defaults.suffix !== undefined) ds.value = defaults.suffix;
        }
      } catch (err) {
        console.error("Error in onmessage handler:", err);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      // Apply Dynamic Button
      // dynamic input removed — no apply button

      // Activate License Button
      const licenseBtn = getElement("activateLicense");
      if (licenseBtn) {
        licenseBtn.addEventListener("click", () => {
          const input = getElement("licenseKeyInput");
          const licenseKey = input ? input.value.trim() : "";

          if (!licenseKey) {
            const errorEl = getElement("errorMessage");
            if (errorEl) {
              errorEl.textContent = "Please enter a license key";
              errorEl.classList.add("show");
            }
            return;
          }

          if (isProcessing) {
            console.warn("Already processing");
            return;
          }

          isProcessing = true;
          licenseBtn.disabled = true;
          licenseBtn.textContent = "Validating...";

          postMessage({
            type: "activate-license",
            licenseKey: licenseKey
          });
        });
      }

      // Buy License Link
      const buyLink = getElement("buyLink");
      if (buyLink) {
        buyLink.href = getCheckoutUrl();
        buyLink.addEventListener("click", (e) => {
          e.preventDefault();
          const url = getCheckoutUrl();
          window.open(url, 'dodo_checkout', 'width=600,height=800');
        });

      }

      // License Key Input - Allow Enter to submit
      const keyInput = getElement("licenseKeyInput");
      if (keyInput) {
        keyInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && licenseBtn) {
            licenseBtn.click();
          }
        });

        // Clear error when user starts typing
        keyInput.addEventListener("input", () => {
          const errorEl = getElement("errorMessage");
          if (errorEl) {
            errorEl.classList.remove("show");
          }
        });
      }

      // dynamic input removed

      // Settings button
      const settingsBtn = getElement('settingsBtn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          const license = getElement('licenseBox');
          const settings = getElement('settingsBox');
          const dynamic = getElement('dynamicBox');
          if (license) license.classList.add('hidden');
          if (dynamic) dynamic.classList.add('hidden');
          if (settings) settings.classList.remove('hidden');
          // Request current defaults from plugin
          postMessage({ type: 'request-defaults' });
        });
      }

      const saveDefaultsBtn = getElement('saveDefaults');
      if (saveDefaultsBtn) {
        saveDefaultsBtn.addEventListener('click', () => {
          const dp = getElement('defaultPrefix');
          const db = getElement('defaultBetween');
          const ds = getElement('defaultSuffix');
          postMessage({ type: 'save-defaults', defaults: { prefix: dp ? dp.value : '', between: db ? db.value : '', suffix: ds ? ds.value : '' } });
        });
      }

      const cancelDefaults = getElement('cancelDefaults');
      if (cancelDefaults) {
        cancelDefaults.addEventListener('click', () => {
          const license = getElement('licenseBox');
          const settings = getElement('settingsBox');
          if (settings) settings.classList.add('hidden');
          if (license) license.classList.remove('hidden');
        });
      }

      // Pro Dashboard buttons
      const supportBtn = getElement('supportBtn');
      if (supportBtn) {
        supportBtn.addEventListener('click', () => {
          // Open support page — replace with real support URL if available
          window.open('jdip19.github.io', '_blank', 'noopener');
        });
      }

      const logoutBtn = getElement('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          renderFreeView({ remaining: 0, price: licensePrice });
          postMessage({ type: 'logout' });
        });
      }

      // Show confirmation when defaults saved
      window.addEventListener('message', (ev) => {
        try {
          const msg = ev.data?.pluginMessage;
          if (!msg) return;
          if (msg.type === 'defaults-saved') {
            const m = getElement('defaultsSavedMsg');
            if (m) {
              m.style.display = 'block';
              setTimeout(() => { m.style.display = 'none'; }, 1800);
            }
          }
        } catch (e) {
          // ignore
        }
      });
    });

    // Initial focus on load
    window.addEventListener("load", () => {
      const input = getElement("licenseKeyInput");
      if (input && !input.classList.contains("hidden")) {
        setTimeout(() => input.focus(), 100);
      }
    });
    function hideAllViews() {
      ['licenseBox', 'proDashboard'].forEach(id => {
        const el = getElement(id);
        if (el) el.classList.add('hidden');
      });
    }

    function renderFreeView(data) {
      hideAllViews();
      const licenseBox = getElement('licenseBox');
      if (licenseBox) licenseBox.classList.remove('hidden');

      const remainingEl = getElement("remainingCount");
      const priceEl = getElement("price");
      const msgEl = getElement("limitMessage");

      const remaining = data?.remaining ?? 0;

      if (remainingEl) remainingEl.textContent = remaining;
      if (priceEl) priceEl.textContent = data?.price ?? 9;

      if (msgEl) {
        msgEl.textContent =
          remaining > 0
            ? `You have ${remaining} free commands left today`
            : `You've reached your daily limit`;
      }

      enableSettings(false);
    }

    function renderProView(license) {
      hideAllViews();
      const proBox = getElement('proDashboard');
      if (proBox) proBox.classList.remove('hidden');

      const eEmail = getElement('proEmail');
      const ePlan = getElement('proPlan');
      const eKey = getElement('proKey');
      const eActivated = getElement('proActivated');
      const eUsage = getElement('proUsage');

      if (eEmail) eEmail.textContent = license.email || '—';
      if (ePlan) ePlan.textContent = license.plan || 'Pro';
      if (eKey) eKey.value = maskKey(license.key || '');
      if (eActivated) eActivated.textContent = formatDate(license.activatedAt);
      if (eUsage) eUsage.textContent = license.unlimited ? 'Unlimited' : '—';

      enableSettings(true);
    }

    function enableSettings(isPro) {
      const btn = getElement('settingsBtn');
      if (btn) btn.style.display = isPro ? 'block' : 'none';
    }


  </script>
</body>

</html>